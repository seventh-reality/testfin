<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web AR - Model Viewer Style</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        #ar-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 18px;
            display: none; /* Hidden by default, will be shown if AR is supported */
        }
    </style>
</head>
<body>

    <!-- AR Button to initiate AR session -->
    <button id="ar-button">Enter AR</button>

    <!-- Three.js and WebXR-related scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r136/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/motion-controllers@0.10.0/dist/motion-controllers.module.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        let scene, camera, renderer;
        let model, reticle;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        const arButton = document.getElementById('ar-button');

        // Check if WebXR is available and show AR button if supported
        if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                if (supported) {
                    arButton.style.display = 'block';  // Show button if AR is supported
                }
            });
        } else {
            alert('WebXR not supported on this device or browser.');
        }

        // Initialize the 3D scene and WebXR environment
        function init() {
            // Create Three.js scene
            scene = new THREE.Scene();

            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

            // Setup WebGL renderer with XR support
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Add hemisphere lighting for model visibility
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            // Load a 3D model (GLTF/GLB format)
            const loader = new THREE.GLTFLoader();
            loader.load('https://modelviewer.dev/shared-assets/models/Astronaut.glb', (gltf) => {
                model = gltf.scene;
                model.visible = false;  // Hide the model initially
                scene.add(model);
            });

            // Create a reticle (circle) to show where the model will be placed
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.15, 0.2, 32).rotateX(- Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x00ff00 })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // AR button handler to initiate AR session
            arButton.addEventListener('click', () => {
                navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test'] })
                    .then(onSessionStarted)
                    .catch((err) => {
                        console.error('Failed to start AR session', err);
                    });
            });

            window.addEventListener('resize', onWindowResize);
        }

        // When AR session starts
        function onSessionStarted(session) {
            renderer.xr.setSession(session);

            // Request hit-test source (to detect surfaces)
            session.requestReferenceSpace('local').then((referenceSpace) => {
                session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                    hitTestSource = source;
                });
            });

            session.addEventListener('end', onSessionEnded);
            session.addEventListener('select', onSelect);  // When user taps, place model

            renderer.setAnimationLoop(render);
        }

        // On AR session end
        function onSessionEnded() {
            hitTestSourceRequested = false;
            hitTestSource = null;
            renderer.setAnimationLoop(null);
        }

        // Handle window resize
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // When user taps, place the model at the reticle's location
        function onSelect() {
            if (reticle.visible) {
                model.position.setFromMatrixPosition(reticle.matrix);
                model.visible = true;  // Show the model
            }
        }

        // Render the scene and manage hit-test results (surface detection)
        function render(timestamp, frame) {
            if (hitTestSource && frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const hitTestResults = frame.getHitTestResults(hitTestSource);

                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(referenceSpace);

                    reticle.visible = true;
                    reticle.matrix.fromArray(pose.transform.matrix);  // Update reticle position based on surface
                } else {
                    reticle.visible = false;  // Hide reticle if no surface is detected
                }
            }

            renderer.render(scene, camera);
        }

        // Initialize the scene and AR environment
        init();
    </script>

</body>
</html>
